// Flow & playful behaviors
const startBtn = document.getElementById('startBtn');
const steps = Array.from(document.querySelectorAll('[data-step]'));
const goToStep = stepName => {
  steps.forEach(s => s.classList.toggle('hidden', s.dataset.step !== stepName));
};
const ageButtons = document.querySelectorAll('.option');
const loveRange = document.getElementById('loveRange');
const percentVal = document.getElementById('percentVal');
const toProposal = document.getElementById('toProposal');
const yesMain = document.getElementById('yesMain');
const noMain = document.getElementById('noMain');
const confirmModal = document.getElementById('confirmModal');
const confirmYes = document.getElementById('confirmYes');
const confirmNo = document.getElementById('confirmNo');
const finalReplay = document.getElementById('replay');
const confettiContainer = document.getElementById('confetti-container');

let yesScale = 1;
let tries = 0;

// init
goToStep('intro');

startBtn.addEventListener('click', ()=> goToStep('age'));

// age buttons -> next
ageButtons.forEach(btn=>{
  btn.addEventListener('click', ()=>{
    // visual feedback (optional)
    btn.animate([{ transform: 'scale(1)' }, { transform: 'scale(1.06)' }, { transform: 'scale(1)' }], { duration:260 });
    setTimeout(()=> goToStep('slider'), 260);
  });
});

// slider
loveRange.addEventListener('input', ()=> {
  percentVal.textContent = loveRange.value;
});
toProposal.addEventListener('click', ()=> goToStep('proposal'));

// proposal logic
function placeInitialProposal(){
  // put buttons centered but with distinct left positions
  yesMain.style.transform = `translateY(0) scale(${yesScale})`;
  yesMain.style.left = '36%';
  yesMain.style.position = 'absolute';
  noMain.style.position = 'absolute';
  noMain.style.left = '64%';
  noMain.style.top = '50%';
  noMain.style.transform = 'translate(-50%, -50%)';
}
window.addEventListener('load', ()=> {
  // if user refreshes on this page
  placeInitialProposal();
});
window.addEventListener('resize', placeInitialProposal);

// move "Nu" and grow "Da"
function moveNoRandom(){
  const wrap = document.querySelector('.proposal-wrap').getBoundingClientRect();
  const btnW = noMain.offsetWidth;
  const btnH = noMain.offsetHeight;
  const padding = 8;
  const minX = padding;
  const maxX = wrap.width - btnW - padding;
  const minY = -10;
  const maxY = wrap.height - btnH + 10;
  const x = Math.floor(Math.random() * (maxX - minX + 1)) + minX;
  const y = Math.floor(Math.random() * (maxY - minY + 1)) + minY;
  noMain.style.left = `${x}px`;
  noMain.style.top = `${y}px`;
  // grow yes a little
  yesScale += 0.08;
  yesMain.style.transform = `translateY(0) scale(${yesScale})`;
  tries++;
}

// when trying to interact with "Nu"
noMain.addEventListener('mouseenter', moveNoRandom);
noMain.addEventListener('touchstart', e => { e.preventDefault(); moveNoRandom(); });

// if user somehow clicks "Nu"
noMain.addEventListener('click', (e)=>{
  yesScale += 0.12;
  yesMain.style.transform = `translateY(0) scale(${yesScale})`;
  noMain.animate([{ transform: 'translateY(0)' }, { transform: 'translateY(-8px)' }, { transform: 'translateY(0)' }], { duration:300, easing:'ease-out' });
});

// clicking main "Da" opens confirm modal
yesMain.addEventListener('click', ()=>{
  showConfirm();
});

// confirm modal behavior
function showConfirm(){
  confirmModal.classList.remove('hidden');
  confirmModal.setAttribute('aria-hidden','false');
}
function hideConfirm(){
  confirmModal.classList.add('hidden');
  confirmModal.setAttribute('aria-hidden','true');
}

confirmNo.addEventListener('click', ()=>{
  // if she chooses "Nu" at confirm, we hide modal and make "Da" grow and bring back proposal
  hideConfirm();
  yesScale += 0.18;
  yesMain.style.transform = `translateY(0) scale(${yesScale})`;
  // small nudge animation
  yesMain.animate([{ transform: `scale(${yesScale})` }, { transform: `scale(${yesScale + 0.12})` }, { transform: `scale(${yesScale})` }], { duration: 360, easing: 'ease-out' });
});

confirmYes.addEventListener('click', ()=>{
  // final acceptance -> go to final page
  hideConfirm();
  goToFinal();
});

// final sequence
function goToFinal(){
  goToStep('final');
  fireConfetti();
}

// replay
if(finalReplay) finalReplay.addEventListener('click', ()=> location.reload() );

/* Simple confetti (no libs) */
function fireConfetti(){
  const colors = ['#ff4d6d','#ffd166','#73d6b7','#7cc6ff','#c59bff'];
  const count = 60;
  for(let i=0;i<count;i++){
    const el = document.createElement('div');
    el.className = 'confetti';
    el.style.background = colors[Math.floor(Math.random()*colors.length)];
    el.style.left = (Math.random()*100) + 'vw';
    el.style.top = (-10 - Math.random()*20) + 'vh';
    el.style.opacity = 0.95;
    el.style.transform = `rotate(${Math.random()*360}deg)`;
    el.style.width = (6 + Math.random()*10) + 'px';
    el.style.height = (8 + Math.random()*12) + 'px';
    document.body.appendChild(el);

    const fallDuration = 1400 + Math.random()*1200;
    el.style.transition = `transform ${fallDuration}ms linear, opacity 600ms ${Math.max(0, fallDuration-600)}ms`;
    void el.offsetHeight;
    el.style.transform = `translateY(${window.innerHeight + 200}px) rotate(${Math.random()*720}deg)`;
    el.style.opacity = 0;

    setTimeout(()=> el.remove(), fallDuration + 800);
  }
}
.modal.hidden { display: none !important; }
.hidden { display: none !important; }
